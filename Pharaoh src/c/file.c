#include <std.h>#include <quickdraw.h>#include <pb.h>#include <packages.h>#include <memory.h>#include <segment.h>#include "strings.h"#define FNFErr -43 /* file not found */TEXT *title = NIL;LOCAL SFReply sf;LOCAL BITS fd, vRefNum;LOCAL LONG eof;TEXT apName[256];	/* name of application file */BITS apRefNum;	/* pathRefNum of application file */BITS apVRefNum;	/* volume Reference number of application file */VOID NewFile()	{	IMPORT BOOL pgmLocked;	if (!pgmLocked)		{		if (QuerryStr(ST_FLSAVE))			SaveFile();		}	title = NIL;	InitGame();	}	BOOL OpenFile()	{	Handle bufHandle;	if (QuerryStr(ST_FLSAVE))		SaveFile();	if (GetTitle())		{		InitGame();		LoadAppFile(vRefNum, title);		}	return(NO);	}	VOID LoadAppFile(PvRefNum, PfName)BITS PvRefNum;TEXT *PfName;	{	Handle bufHandle, RdFile();		bufHandle = RdFile(PvRefNum, PfName);	SymLoad(bufHandle);	DisposHandle(bufHandle);	ContMenuSet();	return(YES);	}	Handle RdFile(PvRefNum, PfName)BITS PvRefNum;TEXT *PfName;	{	Handle bufHandle;	vRefNum = PvRefNum;	title = PfName;		bufHandle = NewHandle(0L);	LoadTitle(bufHandle);	return(bufHandle);	}VOID SaveFile()	{	Handle bufHandle;		bufHandle = NewHandle(0L);	SymDump(bufHandle);	if (!title)		SetTitle();	WriteTitle(bufHandle);	DisposHandle(bufHandle);	}	VOID SaveAsFile()	{	if (SetTitle())		SaveFile();	}/* * File Manipulation Utilities */ VOID LoadTitle(h)Handle h;	{	Watch();	FSOpen(title, vRefNum, &fd);	GetEOF(fd, &eof);	SetHandleSize(h, eof);	HLock(h);	FSRead(fd, &eof, *h);	HUnlock(h);		FSClose(fd);	}/*  * Read a file that is already open  */  Handle RdOpenFile(refNum)BITS refNum;	{	Handle h;		Watch();	h = NewHandle(0L);	SetFPos(refNum, fsFromStart, 0L);	GetEOF(refNum, &eof);	SetHandleSize(h, eof);	HLock(h);	FSRead(refNum, &eof, *h);	HUnlock(h);	return(h);	}	VOID WriteTitle(h)Handle h;	{	BITS err;		Watch();	err = FSOpen(title, vRefNum, &fd);	if (err == FNFErr)	/* file not found? */		{		Create(title, vRefNum, 'PHAR', 'PHSV');		FSOpen(title, vRefNum, &fd);		}		HLock(h);	eof = GetHandleSize(h);	FSWrite(fd, &eof, *h);	HUnlock(h);	SetEOF(fd, eof);	FSClose(fd);	FlushVol(NIL, vRefNum);	}	LOCAL Point dlgPoint = {100,100};	BOOL SetTitle()	{	/*Watch();*/	SFPutFile(pass(dlgPoint), "\PSave Pharaoh Game", (title ? title : "\P"), NIL, &sf);	if (sf.good == pFALSE)		return(NO);	else		{		vRefNum = sf.vRefNum;		title = &sf.fName;		return(YES);		}	}LONG typeList = 'PHSV';BOOL GetTitle()	{	Watch();	SFGetFile(pass(dlgPoint), NIL, NIL, 1, &typeList,				NIL, &sf);		if (sf.good == pFALSE)		{		return(NO);		}	else		{		vRefNum = sf.vRefNum;		title = &sf.fName;		return(YES);		}	}	/*«CheckFinder»  * CheckFinder --	Check the finder information to see if there were any files passed to the  *							application when it was started.  *  *				returns YES if a finder file was passed, else NO.  */  BOOL CheckFinder()	{	pascal OSErr GetVRefNum();	COUNT n, msg;		LOCAL struct		{		BITS msg;		COUNT count;		BITS vRefNum;		LONG type;		TINY vers, notUsed;		TEXT name[256];		} **apParam;			GetAppParms(&apName, &apRefNum, &apParam);	GetVRefNum(apRefNum, &apVRefNum);		n=(**apParam).count;	msg = (**apParam).msg;		if (n == 0)		return(NO);	else if ((msg == appOpen) && (n == 1))			{		if ((**apParam).type != 'PHSV')			{			MessageStr(ST_FLTYPE);			return(NO);			}		else			{			LoadAppFile((**apParam).vRefNum, &((**apParam).name));			return(YES);			}		}	else		{		if (msg != appOpen)			MessageStr(ST_FLPRINT);		if (n != 1)			MessageStr(ST_FLMANY);		}	return(NO);	}			/*«IsFile»  * IsFile -- returns YES if the specified file is present, else returns NO  */    BOOL IsFile(s)  TEXT *s;  	{	FInfo junk;	OSErr code;		ctop(s);	code = GetFInfo(s, 0, &junk);	ptoc(s);	return(code == noErr);	}