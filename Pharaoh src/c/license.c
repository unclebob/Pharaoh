/*  * license.c -- 	This module controls the dialog box which allows the user to enter his   *				license password.  */  #include <std.h>#include <quickdraw.h>#include <textedit.h>#include <dialog.h>#include <event.h>#include <control.h>#include <memory.h>#include <resource.h>#include "pharaoh.h"/*ÇDoDebugÈ  * DoDebug -- control the debug dialog box  */  VOID EnterLicense()	{	DialogRecord d;	BITS item;	Rect r;		GetNewDialog(D_LICENSE, &d, -1L);		FOREVER		{		ModalDialog(NIL, &item);				if (item == DI_CANCEL)			break;		else if (item == DI_OK)			{			BITS x;			Handle editHandle;						GetDItem(&d, DILI_PW, &x, &editHandle, &r);			CheckLicense(editHandle);			}		}			CloseDialog(&d);	}	/* * CheckLicense -- Check the user's password, and if valid, update his license. */ BOOL CheckLicense(h)FAST TEXT **h;	{	Size codeLen, textLen;	Handle oldRes;	unsigned short int **codeHandle, **clearHandle, *p, *c;	TEXT *t;	BOOL status = NO;		codeLen = GetHandleSize(h);	textLen = codeLen;	if (codeLen % 3 > 0)		{		MessageAlert("That is not a valid password.");		return(NO);	/* must be divisible by 3 */		}		codeLen = (codeLen/3)*2;	/* calculate size of real code */	oldRes = GetResource('TEXT', OPEN_ID);	/* get the old resource */	if (oldRes == NIL)		{		MessageAlert("Hay!  This is not a legal version of Pharaoh, somebody has been hacking.");		exit();		}	codeHandle = NewHandle(codeLen);	clearHandle = NewHandle(codeLen);	for (p = *codeHandle, c = *clearHandle, t = *h ; textLen; textLen -= 3, p++, c++, t+=3)		{		unsigned short TextToNum();		*p = TextToNum(t);		*c = *p;		}	if (DeCrypt(clearHandle))		{		GLOBAL BITS appResFile; /* the application resource file */				MessageAlert("Password verified OK, Pharaoh is being unlocked");		UseResFile(appResFile);		AddResource(codeHandle, 'TEXT', PERS_ID, "\PLicense");		if (ResError() == noErr)			{			WriteResource(codeHandle);			MessageAlert("Licensing complete.  Program must be restarted.");			exit();			}		else			MessageAlert("Something went wrong.  Is the disk write protected or something?");		}	else		MessageAlert("The password you entered did not verify...");	DisposHandle(clearHandle);	}	LOCAL TEXT table[] =	{'q','w','e','r','t','y','u','i','o','p','a','s','d','f','g','h','j','k','l','z','x',					 'c','v','b','n','m','6','5','7','4','8','3','9','2','0','1','/','.',',',';','='};	/* * Convert 3 characters into a 16 bit integer via the encoding mechanism. */  unsigned int TextToNum(t)FAST TEXT *t;	{	unsigned int num;		num = lookup(t[0]);	num = num*sizeof(table) + lookup(t[1]);	num = num*sizeof(table) + lookup(t[2]);	return(num);	}/* * Convert a single character into its corresponding number */ COUNT lookup(c)TEXT c;	{	FAST COUNT i;		for (i=0; i<sizeof(table); i++)		if (table[i] == c)			return(i);	return(-1);	}	