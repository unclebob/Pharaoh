#include <std.h>#include <event.h>#include <resource.h>#include <window.h>#include <dialog.h>#include <segment.h>#include "cells.h"#include "pharaoh.h"#include "vars.h"#include "skel.h"#include "macintalk.h"#include "menucmd.h"GLOBAL Rect screenCells[XCELLS][YCELLS];GLOBAL BOOL debugFlag;GLOBAL BITS appResFile = NULL;	/* the ref num of the application resource file */BuySellRecord	wtRec = 		{"\PWheat", &wheat, &wtPrice, NIL, &wtSupply,&wtDemand, NIL},	slRec = 		{"\PSlaves", &slaves, &slPrice, &slHealth, &slSupply,&slDemand, NIL},	hsRec =		{"\PHorses", &horses, &hsPrice, &hsHealth, &hsSupply,&hsDemand, NIL},	oxRec = 		{"\POxen", &oxen, &oxPrice, &oxHealth, &oxSupply,&oxDemand,  NIL},	mnRec = 		{"\PManure", &manure, &mnPrice,NIL, &mnSupply,&mnDemand, NIL},	lnRec = 		{"\PLand", &lnFallow, &lnPrice, NIL, &lnSupply,&lnDemand, NIL},	sewnRec =   	{"\PPlanted Land", &lnSewn, &lnPrice, NIL, &lnSupply,&lnDemand, &wtSewn},	grownRec =	{"\PGrowing Land", &lnGrown, &lnPrice, NIL, &lnSupply,&lnDemand, &wtGrown},	ripeRec = 		{"\PRipened Land", &lnRipe, &lnPrice, NIL, &lnSupply,&lnDemand, &wtRipe};FeedRateRecord	slFdRec =	{"\PSlave", &slFeedRt},	oxFdRec =	{"\POxen", &oxFeedRt},	hsFdRec = {"\PHorse", &hsFeedRt};/*«main»  * The pharaoh program begins here  */GLOBAL COUNT testEvent = -1;SpeechHandle theSpeech;BOOL speechFlag = NO;main()	{	Init();	OpenResFile("\Ppharaoh:res:pharaoh.res"); /* open the resources*/	appResFile = CurResFile();	/* get the current res file ref */	StartSkel(NO);	/* start skeleton without font and style menus */	}	AppInit()	{	VOID PhMouse(), PhUpdate(), PhKey(), PhIdle(),PhCursor();	Rect screenRect;	LOCAL WindowRecord w;	IMPORT BOOL pgmLocked;	LOCAL WindowControl wc = 	{							NIL,			/* windowId */							PhCursor,		/* Cursor */							PhIdle,		/* Idle */							PhMouse,		/* Mouse event */							PhUpdate,		/* Update Event */							PhKey,		/* Key event */							NIL,			/* Activate Event */							NIL,			/* menu stuff */							NIL,			/* set font */							NIL			/* pile */							};	speechFlag = NO;	if (SpeechOn(IsFile("pharaoh.exc") ? "\Ppharaoh.exc" : "", &theSpeech) == 0) 		{		speechFlag = YES;		}	screenRect = screenBits.bounds;	screenRect.top += 20;	/* make room for the menu bar */	NewWindow(&w, &screenRect, "\Pxxx", pTRUE, plainDBox, -1L, NO, NIL);	w.refCon = (LONG)(&wc);	SetPort(&w);	InitGame();	Opening();		if (pgmLocked) /* set up easy parameters for unlicensed programs */		{		MessageAlert("Since you have not yet purchased a license, you must play at the easiest level.");		creditLimit = creditLower = 5e6;		worldGrowth = .15;		lnPrice = 1000;		wtPrice = 10;		slPrice = 1000;		DisableCmd(C_SAVE);		DisableCmd(C_SAVEAS);		DisableCmd(C_OPEN);		DisableCmd(C_CLOSE);		}	else	/* it is licensed */		{		if (!CheckFinder())	/* see if finder started with a file, and if so, open it. */			DoLevel();	/* otherwise ask for a level */		SetCmd(C_PREG, "\PLICENCED");		SetCmd(C_LICENSE, "\PVERSION");		DisableCmd(C_PREG);		DisableCmd(C_LICENSE);		}	}	/*«AppIdle, Transition, about, FSMInit»  * Skeleton functions  */VOID AppIdle()	{	}	VOID Transition(){}VOID FSMInit(){}/*  * about() -- tell the user a little about us, like our version number and stuff.  */  VOID about()	{	MessageAlert("Copyright © 1987,1988 By Robert Martin.  Version 1.2 of Pharaoh.  (hic)");	}/*«PhMouse»  * PhMouse -- Handle mouse events for the pharaoh window  */  VOID PhMouse(w, e, code)WindowPtr w;EventRecord *e;BITS code;	{	DoPhEvent(e);	}	/*«PhCursor»  * PhCursor -- switch to the arrow cursor if the mouse is in the pharaoh window.  */VOID PhCursor()	{	SetCursor(&arrow);	}	/*«PhKey»  * PhKey -- Handle key events for the pharaoh window  */  VOID PhKey(w,e)WindowPtr w;EventRecord *e;	{	DoPhEvent(e);	}	/*«PhUpdate»  * PhUpdate -- Handle update events for the pharaoh window  */  VOID PhUpdate(w, e)WindowPtr w;EventRecord *e;	{	IMPORT BOOL nagCancel;		nagCancel = YES;	BeginUpdate(w);	PrintScreen();	EndUpdate(w);	CheckWin();	}/*«DoPhEvent»  * DoPhEvent -- handle the standard mouse and Key events which select Cells  */  VOID DoPhEvent(e)EventRecord *e;	{	IMPORT BOOL nagCancel;	ResetAlrtStage();	nagCancel = YES;			ResetAlrtStage();	if (IsEvent(e, 'w', CH_WTPRICE, CH_WT, C_WT, C_WTPRICE, NIL))		{		BuySell(&wtRec);		InvalList(C_WT, C_GOLD, NIL);		}	else if (IsEvent(e, 's', CH_SLPRICE, C_SLPRICE, CH_SL, C_SL, NIL))		{		BuySell(&slRec);		InvalList(C_SL, C_GOLD, NIL);		}	else if (IsEvent(e, 'm', CH_MNPRICE, C_MNPRICE, CH_MN, C_MN, NIL))		{		BuySell(&mnRec);		InvalList(C_MN, C_GOLD, NIL);		}	else if (IsEvent(e, 'o', CH_OXPRICE, C_OXPRICE, CH_OX, C_OX, NIL))		{		BuySell(&oxRec);		InvalList(C_OX, C_GOLD, NIL);		}	else if (IsEvent(e, 'h', CH_HSPRICE, C_HSPRICE, CH_HS, C_HS, NIL))		{		BuySell(&hsRec);		InvalList(C_HS, C_GOLD, NIL);		}	else if (IsEvent(e, 'l', CH_LNPRICE, C_LNPRICE, 						CH_LNFALLOW, C_LNFALLOW,						CH_LNTOTAL, C_LNTOTAL,NIL))		{		BuySell(&lnRec);		InvalList(C_LNFALLOW, C_GOLD, C_LNTOTAL, NIL);		}		else if (IsEvent(e, 'P', CH_LNSEWN, C_LNSEWN, NIL))		{		BuySell(&sewnRec);		InvalList(C_LNSEWN, C_GOLD, C_LNTOTAL, NIL);		}	else if (IsEvent(e, 'G', CH_LNGROWN, C_LNGROWN, NIL))		{		BuySell(&grownRec);		InvalList(C_LNGROWN, C_GOLD, C_LNTOTAL, NIL);		}	else if (IsEvent(e, 'R', CH_LNRIPE, C_LNRIPE, NIL))		{		BuySell(&ripeRec);		InvalList(C_LNRIPE, C_GOLD, C_LNTOTAL, NIL);		}	else if (IsEvent(e, 'H', CH_HSFEED, C_HSFEED, NIL))		{		DoFeed(&hsFdRec);		InvalRect(C_HSFEED);		}	else if (IsEvent(e, 'O', CH_OXFEED, C_OXFEED, NIL))		{		DoFeed(&oxFdRec);		InvalRect(C_OXFEED);		}	else if (IsEvent(e, 'S', CH_SLFEED, C_SLFEED, NIL))		{		DoFeed(&slFdRec);		InvalRect(C_SLFEED);		}	else if (IsEvent(e, 'g', CH_OV, C_OV, CH_OVPAY, C_OVPAY, NIL))		{		DoOverseer();		InvalRect(C_OV);		}	else if (IsEvent(e, 'L', CH_LOAN, C_LOAN, CH_INTEREST, C_INTEREST, 						CH_GOLD, C_GOLD, NIL))		{		DoLoan();		InvalList(C_LOAN, C_INTEREST, C_GOLD, C_CREDLIM, NIL);		}			else if (IsEvent(e, 'p', CH_LNTOSEW, C_LNTOSEW, NIL))		{		DoPlant();		InvalRect(C_LNTOSEW);		}	else if (IsEvent(e, 'f' ,CH_MNTOSPRD, C_MNTOSPRD, NIL))		{		DoSpread();		InvalRect(C_MNTOSPRD);		}	else if (IsEvent(e, 'q', CH_PYQUOTA, C_PYQUOTA, NIL))		{		DoPyramid();		InvalRect(C_PYQUOTA);		}	else if (IsEvent(e,'r', B_RUN, NIL))		{		FAST COUNT x,y;		DoRun();		InvalList(	C_WT,	C_SL,	C_HS,	C_OX,	C_MN,				C_DPWT,	C_DPSL,	C_DPHS,	C_DPOX,	C_DPMN,				C_OWT, 	C_OSL,	C_OHS,	C_OOX,	C_OMN,	NIL);		InvalList(	C_WTPRICE,		C_MNPRICE,		C_SLPRICE,				C_HSPRICE,		C_OXPRICE,		C_LNPRICE,				C_SLFEED,		C_OXFEED,		C_HSFEED,				C_OV, 			C_OVPAY,		NIL);		InvalList(	C_LOAN,			C_INTEREST, 	C_CREDLIM,				C_LNFALLOW,		C_LNSEWN,		C_LNGROWN,				C_LNRIPE,		C_LNTOTAL,		NIL);		InvalList(	C_GOLD,			C_DPGOLD,		C_OLDGOLD,		NIL);		InvalList(	C_MNTOSPRD,		C_LNTOSEW,				C_MONTH, 		C_YEAR,				C_PYQUOTA, 		C_PYHEIGHT, 		C_PYSTONES,				NIL);						if (debugFlag)			DebugInval();		else			ContInval();		}			else if (IsEvent(e,0, B_QUIT, NIL))		DoQuit();	}		/*«InvalList»  * InvalList -- Invalidate a list of rectangles  */  VOID InvalList(rl)Rect *rl;	{	FAST Rect **rp;		for (rp = &rl; *rp; rp++)		InvalRect(*rp);	}	