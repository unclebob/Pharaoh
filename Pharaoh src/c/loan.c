/*  * loan.c -- This module controls the loan dialog box  */  #include <std.h>#include <quickdraw.h>#include <dialog.h>#include <event.h>#include <control.h>#include "vars.h"#include "pharaoh.h"#include "random.h"#include "strings.h"#include "interpolate.h"/* local variables */BOOL borrowFlag=NO, repayFlag=NO;ControlHandle borrowRb, repayRb;Table tRepayIndex = {0.0, 0.1,		/* the index is based on loan/payment and represents */							/* adjustments to the credit rating*/		1.0,1.02,1.05,1.1,1.15,1.2,1.25,1.275,1.282,1.295,1.3};/*«DoLoan»  * DoLoan -- control the loan dialog box  */  VOID DoLoan()	{	IMPORT BOOL dunnCancel;	DialogRecord d;	BITS item;	DOUBLE transAmt;	Rect r;		borrowFlag = repayFlag = NO;	GetNewDialog(D_LOAN, &d, -1L);		GetDItem(&d, DILN_BORROW, &item, &borrowRb, &r);	GetDItem(&d, DILN_REPAY, &item, &repayRb, &r);		FOREVER		{		pascal short LNFilter();				ModalDialog(&LNFilter, &item);				if (item == DI_CANCEL)			break;		else if (item==DILN_BORROW || item==DILN_REPAY)			{			SetCtlValue(borrowRb, borrowFlag = (item==DILN_BORROW));			SetCtlValue(repayRb, repayFlag = (item==DILN_REPAY));			}		else if (item == DI_OK)			{			TEXT num[256]; /* dialog edits can't return anything bigger */			BITS x;			Handle editHandle;			DOUBLE atof();						GetDItem(&d, DILN_EDIT, &x, &editHandle, &r);			GetIText(editHandle, &num);			ptoc(&num);						if (!IsNumeric(&num))				{				ErrorStr(ST_LNIN);				continue;				}							if (!(borrowFlag || repayFlag))				{				ErrorStr(ST_LNSF);				continue;				}							transAmt = atof(&num);			if (transAmt < 0)				{				ErrorStr(ST_LNNN);				continue;				}			if (borrowFlag)				Loan(transAmt);				else if (repayFlag)				{				if (transAmt > gold)					{					ErrorStr(ST_LNOVER); 					continue; 					}				else if (transAmt >= (loan-.001)) /* the payoff */					{					MessageStr(ST_LNPAID);					gold -= loan;					loan = 0;					creditRating += (1-creditRating)/3; 					intAddition *= 0.80;					dunnCancel = YES;					}				else					{					DOUBLE repayIndex;										repayIndex = interpolate(transAmt/loan, &tRepayIndex);					creditRating *= repayIndex;					creditRating = min(creditRating, 1.0);					intAddition /= repayIndex;					gold -= transAmt;					loan -= transAmt;					if (transAmt > (loan/100))	/* if payment is more than 1% */						{						dunnCancel = YES;						}					}				}			break;			}		}			CloseDialog(&d);	}		/*«LNFilter»  * LNFilter  -- 	the filter proc for the Loan dialog.  Checks the flags to see if a function  * 				has been selected.  If not, the b or r keys will select one.  */  pascal short LNFilter(d, e, item)DialogPtr d;EventRecord *e;BITS *item;	{	if (e->what == keyDown && ((TEXT)e->message) == '\r')		{		*item = DI_OK;		return(pTRUE);		}	if (borrowFlag || repayFlag)		return(pFALSE);	if (e->what == keyDown)		{		TEXT c;		c = e->message;		c = tolower(c);		if (c == 'b')			{			*item = DILN_BORROW;			return(pTRUE);			}		if (c == 'r')			{			*item = DILN_REPAY;			return(pTRUE);			}		return(pFALSE);		}	return(pFALSE);	}			/*«Loan»  * Loan -- Provide credit and funds for a loan.  */  VOID Loan(amt)DOUBLE amt;	{	DOUBLE oldCreditLimit, cost;	IMPORT BOOL dunnCancel;	oldCreditLimit = creditLimit;		if ((loan+amt) > creditLimit)		{ 		if (QuerryStr(ST_LNEXC, cost=(loan+amt)*GRandom(.05, .01))) /* ask user */			{ 			DOUBLE realNetWth;			amt += cost;			realNetWth = 	(slaves * slPrice * slHealth) + 						(oxen * oxPrice * oxHealth) + 						(horses * hsPrice * hsHealth)+ 						lnTotal * lnPrice + 						manure * mnPrice + 						wheat * wtPrice + gold - loan;									creditLimit = realNetWth * creditRating;			creditLimit = max(creditLimit , creditLower);			}		else /* he doesn't want to pay for a credit check */			return;		}				if ((loan+amt) <= creditLimit)		{		loan += amt;		gold += amt;		/* adjust interest rate if loan is close to limit */				if ((creditLimit-loan)/creditLimit < .2)			intAddition += .2;		MessageStr(ST_LNGRANT, amt, interest+intAddition);		dunnCancel = YES;		}	else		{ 		MessageStr(ST_LNSORRY);		creditLimit = oldCreditLimit;		gold = max(0, gold-cost); 		}	}