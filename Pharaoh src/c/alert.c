/*  * Control the Alert box mechanism  */  #include <std.h>#include <quickdraw.h>#include <dialog.h>#include <control.h>#include <osutil.h>#include <macintalk.h>#include <memory.h>#include <resource.h>#include <window.h>#include "strings.h"#define ALRT_ERR	256	/* the resource id of the error alert box */#define ALRT_MSG	257	/* the resource id of the message alert box */#define ALRT_QUY	258	/* the resource id of the querry box */#define ALRT_WRN	512	/* the resource id of the warning box */#define ALRT_WIN	511	/* the "You win" Alert */TEXT *GetCString();BITS ErrorAlert(), MessageAlert(), WarningAlert();BOOL QuerryAlert();SpeechHandle theSpeech;/*«ErrorAlert»  * ErrorAlert(msg) -- Put up a stop alert with the error message displayed.  */  BITS ErrorAlert(msg)TEXT *msg;	{	TEXT pMsg[256];	BITS MyAlert();		strncpy(pMsg, msg, 255);	pMsg[255] = NULL;	ctop(pMsg);	ParamText(pMsg, NIL, NIL, NIL);	SpeechRate(theSpeech, 190);	SpeechPitch(theSpeech, 170, Natural); 		return(MyAlert(ALRT_ERR, NIL,YES));	}/*«ErrorStr»  * ErrorStr -- Select an error message from a string list resource, and generate an error alert  */  BITS ErrorStr(id, param, p2, p3)BITS id;DOUBLE param, p2,p3;	{	TEXT tmp[256], msg[256];		GetCString(tmp, id);	sprintf(msg, tmp, param, p2, p3);	return(ErrorAlert(msg));	}	/*«MessageStr»  * MessageStr -- Select a message from a string list resource, and generate an Message alert  */  BITS MessageStr(id, param,p2,p3)BITS id;DOUBLE param,p2,p3;	{	TEXT tmp[256], msg[256];		GetCString(tmp, id);	sprintf(msg, tmp, param,p2,p3);	SpeechRate(theSpeech, 190);	SpeechPitch(theSpeech, 170, Natural); 	return(MessageAlert(msg));	}	/*«MessageAlert»  * MessageAlert(msg) -- Put up a stop alert with the error message displayed.  */  BITS MessageAlert(msg)TEXT *msg;	{	TEXT pMsg[256];	BITS MyAlert();		strncpy(pMsg, msg, 255);	pMsg[255] = NULL;	ctop(pMsg);	ParamText(pMsg, NIL, NIL, NIL);	SpeechRate(theSpeech, 190);	SpeechPitch(theSpeech, 170, Natural); 		return(MyAlert(ALRT_MSG, NIL, YES));	}/*«QuerryStr»  * QuerryStr -- Select an query message from a string list resource, and generate an query alert  */  BOOL QuerryStr(id, param,p2,p3)BITS id;DOUBLE param,p2,p3;	{	TEXT tmp[256], msg[256];		GetCString(tmp, id);	sprintf(msg, tmp, param,p2,p3);	return(QuerryAlert(msg));	}	/*«QuerryAlert»  * QuerryAlert(msg) -- Put up an alert which asks a question.  Returns YES or NO.  */  BOOL QuerryAlert(msg)TEXT *msg;	{	TEXT pMsg[256];	BITS MyAlert();		strncpy(pMsg, msg, 255);	pMsg[255] = NULL;	ctop(pMsg);	ParamText(pMsg, NIL, NIL, NIL);		SpeechRate(theSpeech, 190);	SpeechPitch(theSpeech, 170, Natural); 	return(MyAlert(ALRT_QUY, NIL, YES) == 1);	}/*«WarningStr»  * WarningStr -- Select a warning message from a string list resource, and generate an warning alert  */  BITS WarningStr(id, param,p2,p3)BITS id;DOUBLE param,p2,p3;	{	TEXT tmp[256], msg[256];		GetCString(tmp, id);	sprintf(msg, tmp, param,p2,p3);	return(WarningAlert(msg));	}	/*«WarningAlert»  * WarningAlert(msg) -- Put up a stop alert with the warning message displayed.  */  BITS WarningAlert(msg)TEXT *msg;	{	TEXT pMsg[256];	BITS MyAlert();		strncpy(pMsg, msg, 255);	pMsg[255] = NULL;	ctop(pMsg);	ParamText(pMsg, NIL, NIL, NIL);		SpeechRate(theSpeech, 190);	SpeechPitch(theSpeech, 170, Natural); 	return(MyAlert(ALRT_WRN, NIL, YES));	}/*«ManAlert»  * ManAlert -- put up a message from one of our neighbors  */  BITS ManAlert(id, stringId)BITS id, stringId;	{	BITS MyAlert();	TEXT msg[256];		GetCString(msg, stringId);	ctop(msg);	ParamText(msg, NIL, NIL, NIL);	SelVoice(id);	return(MyAlert(id, NIL, NO));	}/*«WinAlert»  * WinAlert --	Tell the player that he has won, and that he is great  */  VOID WinAlert()	{	TEXT msg[256];		GetCString(msg, ST_CONGRATS);	ctop(msg);	ParamText(msg, NIL, NIL, NIL);	MyAlert(ALRT_WIN, NIL, YES);	}/*«MyAlert»  * MyAlert -- Replaces the Dialog manager 'Alert' function, allows speaking of param 0  */#define Param0 (*((TEXT ***)0xAA0))#define ACount (*((COUNT *)0xA9A))#define STAGE(stages, stage) (0xf & (stages >> (stage * 4)))#define DRAWBOX(stage) (stage & 4)#define SOUND(stage) (0x3 & stage)#define DEFITEM(stage) ((0x1 & (stage >> 3)) + 1)LOCAL BITS stageWord;BITS MyAlert(id, filter, waitFlag)BITS id;Boolean (*filter)();BOOL waitFlag;	/* if waitFlag is NO, and speech is on, then don't wait for button */	{	Handle items;	COUNT stage;	SpeechErr speechCode;	IMPORT BOOL speechFlag;	struct 		{		Rect bounds;		BITS ditl;		BITS stages;		}**at;		stage = ACount;	ACount = min(3, ACount+1);	at = GetResource('ALRT', id);	stageWord = STAGE((**at).stages, stage);	DABeep(SOUND(stageWord));	if (DRAWBOX(stageWord))		{		DialogRecord d;		BITS item;		pascal short AlertFilter(), NoWaitFilter();				items = GetResource('DITL', (**at).ditl);				/* now put up the dialog */		NewDialog(&d, &((**at).bounds),"\P", TRUE, dBoxProc,-1L, FALSE, 0L, items);		DrawDialog(&d);		if (!waitFlag && speechFlag) /* if not waiting, disable OK button */			{			ControlHandle c;			BITS type;			Rect box;			GetDItem(&d, 1, &type, &c, &box); /* 1 is the OK button by definition. */			HiliteControl(c, 255);	/* disable it */			}					SayHandle(Param0);				if (waitFlag || !speechFlag) /* wait if no speech or if requested */			ModalDialog(&AlertFilter, &item);		else			ModalDialog(&NoWaitFilter, &item);		CloseDialog(&d);		ReleaseResource(items);		return(item);		}	}pascal short AlertFilter(d,e,item)DialogPtr d;EventRecord *e;BITS *item;	{	if (e->what == keyDown && ((TEXT)e->message) == '\r')		{		*item = DEFITEM(stageWord);		return(pTRUE);		}	return(pFALSE);	}pascal short NoWaitFilter(d,e,item)DialogPtr d;EventRecord *e;BITS *item;	{	*item = DEFITEM(stageWord);	return(pTRUE);	}/*«DABeep»  * DABeep -- Beep the bell the number of times specified by the parameter  */  VOID DABeep(n)COUNT n;	{	while (n--)		SysBeep(10);	}